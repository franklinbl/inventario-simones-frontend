<div class="main-container">
  <div class="mb-4">
    @if (isEditing) {
    <span class="flex items-center">
      <mat-icon
        class="icon mr-2 cursor-pointer"
        [svgIcon]="'arrow-left-to-line'"
        (click)="redirectToRentals()"
      ></mat-icon>
      <h2>Editar renta</h2>
    </span>
    } @else {
    <span class="flex items-center">
      <mat-icon
        class="icon mr-2 cursor-pointer"
        [svgIcon]="'arrow-left-to-line'"
        (click)="redirectToRentals()"
      ></mat-icon>
      <h2>Nueva renta</h2>
    </span>
    <p class="text-sm text-[#6E7777]">
      Crea una nueva renta de equipos y mobiliario para un evento.
    </p>
    }
  </div>

  <div class="grid grid-cols-2 auto-rows-auto gap-4">
    <div class="bg-white rounded-lg shadow-md border-1 border-[#E2E5E3] p-4">
      <div class="flex items-center gap-2 mb-4">
        <mat-icon
          class="icon mr-2 cursor-pointer"
          [svgIcon]="'search'"
        ></mat-icon>
        <span class="font-semibold text-slate-800">Buscar Usuario</span>
      </div>

      <div class="flex gap-4 items-center">
        <app-input-field
          placeholder="Ingresa tu nombre"
          ngDefaultControl
          type="text"
          [formControl]="clientDniCtrl"
        ></app-input-field>

        <app-button (click)="searchClient()">Buscar</app-button>

        <app-button type="secondary-outline" (click)="newClient()"
          >Nuevo</app-button
        >
      </div>
    </div>

    <div class="bg-white col-start-1 row-start-2 rounded-lg shadow-sm p-4">
      <!-- Icono + Título -->
      <div class="flex items-center gap-2 mb-4">
        <mat-icon
          class="icon mr-2 cursor-pointer"
          [svgIcon]="'user'"
        ></mat-icon>
        <span class="font-semibold text-slate-800">Datos del Cliente</span>
      </div>

      <!-- Nombre -->
      <div class="mb-4">
        <label class="block text-slate-700 font-medium mb-1"
          >Nombre del Cliente</label
        >
        <app-input-field
          placeholder="Nombre completo"
          ngDefaultControl
          type="text"
        ></app-input-field>
      </div>

      <!-- Cédula + Teléfono -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-slate-700 font-medium mb-1"
            >Cédula del Cliente</label
          >
          <app-input-field
            placeholder="12345678"
            ngDefaultControl
            type="text"
          ></app-input-field>
        </div>

        <div>
          <label class="block text-slate-700 font-medium mb-1"
            >Teléfono del Cliente</label
          >
          <app-input-field
            placeholder="0424 1234567"
            ngDefaultControl
            type="text"
          ></app-input-field>
        </div>
      </div>
    </div>

    <form
      [formGroup]="rentalForm"
      class="bg-white col-start-1 row-start-3 rounded-lg shadow-sm p-4"
    >
      <!-- Icono + Título -->
      <div class="flex items-center gap-2 mb-4">
        <mat-icon
          class="icon mr-2 cursor-pointer"
          [svgIcon]="'calendar'"
        ></mat-icon>
        <span class="font-semibold text-slate-800">Datos de la Renta</span>
      </div>

      <!-- Fechas -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-slate-700 font-medium mb-1"
            >Fecha de Renta</label
          >
          <app-input-field
            formControlName="start_date"
            ngDefaultControl
            type="calendar"
          ></app-input-field>
        </div>
        <div>
          <label class="block text-slate-700 font-medium mb-1"
            >Fecha de Devolución</label
          >
          <app-input-field
            formControlName="end_date"
            ngDefaultControl
            type="calendar"
          ></app-input-field>
        </div>
      </div>

      <!-- Transporte y Precio -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-slate-700 font-medium mb-1"
            >Tipo de Transporte</label
          >
          <app-input-field
            ngDefaultControl
            type="select"
            [selectOption]="selectOption"
          ></app-input-field>
        </div>
        <div>
          <label class="block text-slate-700 font-medium mb-1"
            >Precio del transporte</label
          >
          <app-input-field
            placeholder="0"
            ngDefaultControl
            type="number"
          ></app-input-field>
        </div>
      </div>

      <!-- Descuento -->
      <div class="mb-4">
        <label
          class="block text-slate-700 font-medium mb-1 flex items-center gap-1"
        >
          Descuento a cliente
        </label>
        <app-input-field
          placeholder="0"
          ngDefaultControl
          type="number"
        ></app-input-field>
      </div>

      <!-- Notas -->
      <div>
        <label class="block text-slate-700 font-medium mb-1">Notas</label>
        <app-input-field ngDefaultControl type="textarea"></app-input-field>
      </div>
    </form>

    <div
      class="bg-white row-span-3 col-start-2 row-start-1 rounded-xl shadow-sm border border-gray-200 p-6"
    >
      <div class="flex items-center gap-2 mb-4">
        <mat-icon
          class="icon mr-2 cursor-pointer"
          [svgIcon]="'package'"
        ></mat-icon>
        <h2 class="text-lg font-semibold text-gray-900">
          Seleccionar productos
        </h2>
      </div>

      <div class="mb-4">
        <app-input-field
          type="search-select"
          label="Buscar producto"
          placeholder="Escribe para buscar..."
          [filteredProducts]="filteredProducts"
          (searchChange)="loadProducts()"
          [formControl]="productFilterCtrl"
          (productSelected)="onProductSelected($event)"
        ></app-input-field>

        <div class="space-y-3 mt-3">
          @if (selectedProducts.length > 0) {
            @for (product of selectedProducts; track product.product.id) {
              <div class="px-4 py-2 bg-gray-50 rounded-xl border border-gray-200">
                <div class="flex justify-between">
                  <div>
                    <h3 class="font-medium text-gray-900">{{ product.product.name }}</h3>
                    <p class="text-sm font-medium text-gray-500">
                      Stock disponible: {{ product.product.available_quantity }}
                    </p>
                  </div>
                  <div class="flex items-center">
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium text-gray-700">Cantidad</span>
                      <input
                        type="number"
                        [value]="1"
                        min="1"
                        [max]="product.product.available_quantity"
                        class="w-20 px-3 py-2 bg-yellow-50 border border-gray-200 rounded-lg text-center text-gray-900"
                      />
                    </div>
                    <button
                      class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                      (click)="removeProduct(product.product.id)"
                    >
                      <mat-icon class="icon mr-2 cursor-pointer" [svgIcon]="'trash'"></mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            }
          } @else {
            <div class="text-sm text-gray-500">No hay productos seleccionados.</div>
          }
        </div>



      </div>
    </div>
  </div>

  <!-- <div class="flex items-center mb-4">
    <mat-icon class="icon mr-2 cursor-pointer" [svgIcon]="'arrow-left-to-line'" (click)="redirectToRentals()"></mat-icon>
    @if (isEditing) {
      <h2>Editar renta</h2>
    } @else {
      <h2>Registrar nueva renta</h2>
    }
  </div>

  <div class="form-container">
    <div class="user-data">
      <h3 style="margin-bottom: 10px;">Datos del usuario</h3>

      <div class="form-group" style="width: 100%;">
        <label for="customInput">Buscar Usuario</label>
        <div style="display: flex; align-items: center; gap: 0;">
          <input
            type="text"
            id="customInput"
            [(ngModel)]="clientDniInput"
            [ngModelOptions]="{standalone: true}"
            name="customInputValue"
            class="form-control"
            placeholder="Ingresa cédula"
            style="width: 50%; border-top-right-radius: 0; border-bottom-right-radius: 0;"
          >
          <div style="width: 50%; display: flex; justify-content: flex-end; gap: 8px;">
            <button type="button" class="primary-button" style="width: 45%;" (click)="searchClient()">Buscar</button>
            <button type="button" class="secondary-button" style="width: 45%;" (click)="newClient()">Nuevo</button>
          </div>
        </div>
      </div>
      <form [formGroup]="clientForm" class="client-form">
        <div class="form-row" style="margin-top: 20px;">
          <div class="form-group">
            <label for="name">Nombre del Cliente</label>
            <input
              type="text"
              id="name"
              formControlName="name"
              class="form-control"
              placeholder="Daniel Valera"
              [class.is-invalid]="clientForm.get('name')?.invalid && clientForm.get('name')?.touched"
            >
            @if (clientForm.get('name')?.invalid && clientForm.get('name')?.touched) {
              <div class="error-message">
                {{ getErrorMessage('name') }}
              </div>
            }
          </div>
          <div class="form-group">
            <label for="dni">Cédula del Cliente</label>
            <input
              type="text"
              id="dni"
              formControlName="dni"
              class="form-control"
              placeholder="1234567890"
              [class.is-invalid]="clientForm.get('dni')?.invalid && clientForm.get('dni')?.touched"
            >
            @if (clientForm.get('dni')?.invalid && clientForm.get('dni')?.touched) {
              <div class="error-message">
                {{ getErrorMessage('dni') }}
              </div>
            }
          </div>
          <div class="form-group">
            <label for="phone">Teléfono del Cliente</label>
            <input
              type="tel"
              id="phone"
              formControlName="phone"
              class="form-control"
              placeholder="04123456789"
              [class.is-invalid]="clientForm.get('phone')?.invalid && clientForm.get('phone')?.touched"
            >
            @if (clientForm.get('phone')?.invalid && clientForm.get('phone')?.touched) {
              <div class="error-message">
                {{ getErrorMessage('phone') }}
              </div>
            }
          </div>
        </div>
      </form>
    </div>

    <div class="rental-data">
      <h3>Datos de la renta</h3>
      <form [formGroup]="rentalForm" class="rental-form" style="margin-top: 1rem;">
        <div class="form-row">
          <div class="form-group">
            <label for="start_date">Fecha de Renta</label>
            <input
              type="date"
              id="start_date"
              formControlName="start_date"
              class="form-control"
              [class.is-invalid]="rentalForm.get('start_date')?.invalid && rentalForm.get('start_date')?.touched"
            >
            @if (rentalForm.get('start_date')?.invalid && rentalForm.get('start_date')?.touched) {
             <div class="error-message">
               {{ getErrorMessage('start_date') }}
             </div>
            }
          </div>

          <div class="form-group">
            <label for="end_date">Fecha de Devolución</label>
            <input
              type="date"
              id="end_date"
              formControlName="end_date"
              class="form-control"
              [class.is-invalid]="rentalForm.get('end_date')?.invalid && rentalForm.get('end_date')?.touched"
            >
            @if (rentalForm.get('end_date')?.invalid && rentalForm.get('end_date')?.touched) {
             <div class="error-message">
               {{ getErrorMessage('end_date') }}
             </div>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="delivery_type">Tipo de Transporte</label>
            <mat-form-field class="delivery-select">
              <mat-select formControlName="is_delivery_by_us" placeholder="Seleccionar tipo de transporte">
                <mat-option [value]="true">Transporte por nosotros</mat-option>
                <mat-option [value]="false">Transporte por cliente</mat-option>
              </mat-select>
            </mat-form-field>
            @if (rentalForm.get('is_delivery_by_us')?.invalid && rentalForm.get('is_delivery_by_us')?.touched) {
             <div class="error-message">
               {{ getErrorMessage('is_delivery_by_us') }}
             </div>
            }
          </div>

          <div class="form-group">
            <label for="delivery_price">Precio del transporte</label>
            <input
              type="number"
              id="delivery_price"
              formControlName="delivery_price"
              class="form-control"
              placeholder="0.00"
              min="0"
              step="0.01"
              [class.is-invalid]="rentalForm.get('delivery_price')?.invalid && rentalForm.get('delivery_price')?.touched"
            >
            @if (rentalForm.get('delivery_price')?.invalid && rentalForm.get('delivery_price')?.touched) {
             <div class="error-message">
               {{ getErrorMessage('delivery_price') }}
             </div>
            }
          </div>
        </div>

        <div class="form-row">
         <div class="form-group">
           <label for="discount">Descuento a cliente</label>
           <input
             type="number"
             id="discount"
             formControlName="discount"
             class="form-control"
             placeholder="0.00"
             min="0"
             step="0.01"
             [class.is-invalid]="rentalForm.get('discount')?.invalid && rentalForm.get('discount')?.touched"
           >
           @if (rentalForm.get('discount')?.invalid && rentalForm.get('discount')?.touched) {
            <div class="error-message">
              {{ getErrorMessage('discount') }}
            </div>
           }
         </div>
        </div>

        <div class="form-group">
         <label for="notes">Notas</label>
         <textarea
           id="notes"
           formControlName="notes"
           class="form-control"
           rows="3"
         ></textarea>
       </div>
      </form>
    </div>

    <div class="rental-products">
      <h3>Seleccionar productos</h3>

      <form [formGroup]="rentalForm" class="rental-form" style="margin-top: 1rem;">
        <div class="form-group">
          <label>Productos</label>
          <mat-form-field class="product-select">
            <mat-select [formControl]="selectedProductCtrl" placeholder="Sillas">
              <mat-option>
                <ngx-mat-select-search
                  [formControl]="productFilterCtrl"
                  placeholderLabel="Buscar producto..."
                  noEntriesFoundLabel="No se encontraron productos"
                  (ngModelChange)="loadProducts()"
                ></ngx-mat-select-search>
              </mat-option>
              @for (product of filteredProducts | async; track $index) {
               <mat-option [value]="product">
                 {{product.name}} - Stock: {{product.available_quantity}}
               </mat-option>
              }
            </mat-select>
          </mat-form-field>

          @if (selectedProducts.length > 0) {
            <div class="selected-products-list">
             @for (item of selectedProducts; track $index) {
              <div class="selected-product">
                <div class="product-info">
                  <span class="product-name">{{item.product.name}}</span>
                  <span class="product-stock">Stock disponible: {{item.product.available_quantity}}</span>
                </div>
                <div class="product-quantity">
                  <div class="form-group">
                    <label for="quantity_rented"><small>Cantidad</small></label>
                    <input
                      type="number"
                      id="quantity_rented"
                      [min]="1"
                      [max]="item.product.available_quantity"
                      [formControl]="$any(productsFormArray.at($index).get('quantity_rented'))"
                      class="form-control"
                      placeholder="10"
                    >
                    @if (productsFormArray.at($index).get('quantity')?.invalid && productsFormArray.at($index).get('quantity')?.touched) {
                     <div class="error-message">
                       {{ getQuantityErrorMessage($index) }}
                     </div>
                    }
                  </div>
                  <button mat-icon-button color="warn" (click)="removeProduct(item.product.id)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
             }
            </div>
          }
        </div>

        <div class="form-actions">
          <button class="secondary-button" (click)="redirectToRentals()">Cancelar</button>
          <button class="primary-button" (click)="onSubmit()" [disabled]="selectedProducts.length === 0 || clientForm.invalid || rentalForm.invalid">
            {{ isEditing ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </form>
    </div>
  </div> -->
</div>
